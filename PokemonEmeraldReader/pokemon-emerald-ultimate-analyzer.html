<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Emerald Ultimate ROM Analyzer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            color: #eee;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-size: 3.5rem;
            background: linear-gradient(45deg, #00d4ff, #ff006e, #ffb700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            animation: gradient 3s ease infinite;
        }

        @keyframes gradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .subtitle {
            color: #95a5a6;
            font-size: 1.3rem;
        }

        .rom-loader {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .drop-zone {
            background: rgba(255, 255, 255, 0.05);
            border: 3px dashed #3498db;
            border-radius: 20px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .drop-zone.loaded {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .drop-zone:hover {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.1);
            transform: scale(1.02);
        }

        .drop-zone.active {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .drop-zone input {
            display: none;
        }

        .drop-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .status-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: none;
        }

        .status-panel.active {
            display: block;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .status-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-label {
            color: #95a5a6;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .status-value {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .found { color: #2ecc71; }
        .not-found { color: #e74c3c; }
        .moved { color: #f39c12; }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 10px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .tab.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .content-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: none;
        }

        .content-panel.active {
            display: block;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .comparison-column {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 1.5rem;
            border: 2px solid transparent;
        }

        .comparison-column.vanilla {
            border-color: #3498db;
        }

        .comparison-column.patched {
            border-color: #e74c3c;
        }

        .column-header {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            text-align: center;
        }

        .data-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 1rem;
        }

        .data-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
        }

        .data-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .data-item.different {
            border-left: 4px solid #f39c12;
        }

        .data-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .data-name {
            font-weight: bold;
            color: #3498db;
        }

        .data-id {
            color: #95a5a6;
            font-size: 0.875rem;
        }

        .address-info {
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            color: #f39c12;
            margin-top: 0.5rem;
        }

        .search-box {
            width: 100%;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .search-box::placeholder {
            color: #95a5a6;
        }

        .export-section {
            background: rgba(46, 204, 113, 0.1);
            border: 2px solid #2ecc71;
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            margin-top: 2rem;
        }

        .export-button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0.5rem;
        }

        .export-button:hover {
            background: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(46, 204, 113, 0.3);
        }

        .pattern-search {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .pattern-results {
            margin-top: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .address-match {
            background: rgba(0, 0, 0, 0.5);
            padding: 0.5rem;
            border-radius: 5px;
            margin: 0.5rem 0;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: #95a5a6;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .type-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 5px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            display: inline-block;
            margin-right: 0.25rem;
        }

        .type-normal { background: #A8A878; }
        .type-fighting { background: #C03028; }
        .type-flying { background: #A890F0; }
        .type-poison { background: #A040A0; }
        .type-ground { background: #E0C068; }
        .type-rock { background: #B8A038; }
        .type-bug { background: #A8B820; }
        .type-ghost { background: #705898; }
        .type-steel { background: #B8B8D0; }
        .type-fire { background: #F08030; }
        .type-water { background: #6890F0; }
        .type-grass { background: #78C850; }
        .type-electric { background: #F8D030; }
        .type-psychic { background: #F85888; }
        .type-ice { background: #98D8D8; }
        .type-dragon { background: #7038F8; }
        .type-dark { background: #705848; }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #3498db;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
        }

        .analysis-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 1rem;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #95a5a6;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.1);
            border: 2px solid #e74c3c;
            border-radius: 10px;
            padding: 1rem;
            margin: 1rem 0;
            color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Pokemon Emerald Ultimate ROM Analyzer</h1>
            <p class="subtitle">Advanced pattern matching to find ALL relocated data addresses</p>
        </header>

        <div class="rom-loader">
            <div class="drop-zone" id="vanillaDropZone">
                <input type="file" id="vanillaInput" accept=".gba">
                <div class="drop-icon">üì¶</div>
                <h3>Vanilla ROM</h3>
                <p>Drop clean Pokemon Emerald here</p>
                <div class="loaded-info hidden">
                    <p style="color: #2ecc71; margin-top: 1rem;">‚úì Loaded</p>
                </div>
            </div>

            <div class="drop-zone" id="patchedDropZone">
                <input type="file" id="patchedInput" accept=".gba">
                <div class="drop-icon">üîß</div>
                <h3>Patched ROM</h3>
                <p>Drop Archipelago/Randomizer ROM here</p>
                <div class="loaded-info hidden">
                    <p style="color: #2ecc71; margin-top: 1rem;">‚úì Loaded</p>
                </div>
            </div>
        </div>

        <div class="status-panel" id="statusPanel">
            <h3 style="margin-bottom: 1rem;">Analysis Results</h3>
            <div class="progress-bar" id="progressBar" style="display: none;">
                <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
            </div>
            <div class="status-grid" id="statusGrid">
                <!-- Status items will be populated here -->
            </div>
            <div class="analysis-stats" id="analysisStats" style="display: none;">
                <!-- Stats will be populated here -->
            </div>
        </div>

        <div class="tabs hidden" id="mainTabs">
            <button class="tab active" data-tab="comparison">Data Comparison</button>
            <button class="tab" data-tab="patterns">Pattern Search</button>
            <button class="tab" data-tab="pokemon">Pokemon</button>
            <button class="tab" data-tab="moves">Moves</button>
            <button class="tab" data-tab="items">Items</button>
            <button class="tab" data-tab="text">Text Strings</button>
            <button class="tab" data-tab="memory">Memory Map</button>
            <button class="tab" data-tab="export">Export</button>
        </div>

        <div class="content-panel active hidden" id="comparison">
            <h2>Data Location Comparison</h2>
            <p style="margin-bottom: 1rem; color: #95a5a6;">Shows where data has moved between vanilla and patched ROMs</p>
            <div class="comparison-grid">
                <div class="comparison-column vanilla">
                    <div class="column-header">Vanilla Addresses</div>
                    <div id="vanillaAddresses"></div>
                </div>
                <div class="comparison-column patched">
                    <div class="column-header">Patched Addresses</div>
                    <div id="patchedAddresses"></div>
                </div>
            </div>
        </div>

        <div class="content-panel hidden" id="patterns">
            <h2>Advanced Pattern Search</h2>
            <div class="pattern-search">
                <p>Comprehensive pattern search to find all relocated data:</p>
                <button class="export-button" onclick="runComprehensiveSearch()">Run Complete Analysis</button>
                <div class="pattern-results" id="patternResults"></div>
            </div>
        </div>

        <div class="content-panel hidden" id="pokemon">
            <h2>Pokemon Data Comparison</h2>
            <input type="text" class="search-box" id="pokemonSearch" placeholder="Search Pokemon...">
            <div class="comparison-grid">
                <div class="comparison-column vanilla">
                    <div class="column-header">Vanilla</div>
                    <div class="data-list" id="vanillaPokemon"></div>
                </div>
                <div class="comparison-column patched">
                    <div class="column-header">Patched</div>
                    <div class="data-list" id="patchedPokemon"></div>
                </div>
            </div>
        </div>

        <div class="content-panel hidden" id="moves">
            <h2>Move Data Comparison</h2>
            <input type="text" class="search-box" id="moveSearch" placeholder="Search moves...">
            <div class="comparison-grid">
                <div class="comparison-column vanilla">
                    <div class="column-header">Vanilla</div>
                    <div class="data-list" id="vanillaMoves"></div>
                </div>
                <div class="comparison-column patched">
                    <div class="column-header">Patched</div>
                    <div class="data-list" id="patchedMoves"></div>
                </div>
            </div>
        </div>

        <div class="content-panel hidden" id="items">
            <h2>Item Data Comparison</h2>
            <input type="text" class="search-box" id="itemSearch" placeholder="Search items...">
            <div class="comparison-grid">
                <div class="comparison-column vanilla">
                    <div class="column-header">Vanilla</div>
                    <div class="data-list" id="vanillaItems"></div>
                </div>
                <div class="comparison-column patched">
                    <div class="column-header">Patched</div>
                    <div class="data-list" id="patchedItems"></div>
                </div>
            </div>
        </div>

        <div class="content-panel hidden" id="text">
            <h2>Text String Analysis</h2>
            <input type="text" class="search-box" id="textSearch" placeholder="Search text strings...">
            <div class="comparison-grid">
                <div class="comparison-column vanilla">
                    <div class="column-header">Vanilla Text</div>
                    <div class="data-list" id="vanillaText"></div>
                </div>
                <div class="comparison-column patched">
                    <div class="column-header">Patched Text</div>
                    <div class="data-list" id="patchedText"></div>
                </div>
            </div>
        </div>

        <div class="content-panel hidden" id="memory">
            <h2>Complete Memory Map</h2>
            <div class="comparison-grid">
                <div class="comparison-column vanilla">
                    <div class="column-header">Vanilla Memory Map</div>
                    <div id="vanillaMemory"></div>
                </div>
                <div class="comparison-column patched">
                    <div class="column-header">Patched Memory Map</div>
                    <div id="patchedMemory"></div>
                </div>
            </div>
        </div>

        <div class="content-panel hidden" id="export">
            <h2>Export Data</h2>
            <p style="margin-bottom: 2rem;">Export complete memory maps and data for your ROM type</p>
            <div class="export-section">
                <h3>Export Options</h3>
                <button class="export-button" onclick="exportCompleteAnalysis('vanilla')">Export Vanilla Analysis</button>
                <button class="export-button" onclick="exportCompleteAnalysis('patched')">Export Patched Analysis</button>
                <button class="export-button" onclick="exportBizHawkModule()">Export BizHawk Module</button>
                <button class="export-button" onclick="exportComparisonReport()">Export Comparison Report</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        var romData = {
            vanilla: {
                buffer: null,
                loaded: false,
                pokemon: [],
                moves: [],
                items: [],
                text: [],
                addresses: {},
                pointerTables: []
            },
            patched: {
                buffer: null,
                loaded: false,
                pokemon: [],
                moves: [],
                items: [],
                text: [],
                addresses: {},
                pointerTables: []
            }
        };

        // Pokemon text encoding
        var POKEMON_ENCODING = {
            0x00: ' ', 0xFF: '', 0xFE: '\n', 0xFD: '', 0xFA: '', 0xFB: '',
            0xA1: '0', 0xA2: '1', 0xA3: '2', 0xA4: '3', 0xA5: '4',
            0xA6: '5', 0xA7: '6', 0xA8: '7', 0xA9: '8', 0xAA: '9',
            0xAB: '!', 0xAC: '?', 0xAD: '.', 0xAE: '-', 0xAF: '¬∑',
            0xB0: '‚Ä¶', 0xB1: '"', 0xB2: '"', 0xB3: ''', 0xB4: ''',
            0xB5: '‚ôÇ', 0xB6: '‚ôÄ', 0xB7: '$', 0xB8: ',', 0xB9: '√ó',
            0xBA: '/', 0xBB: 'A', 0xBC: 'B', 0xBD: 'C', 0xBE: 'D',
            0xBF: 'E', 0xC0: 'F', 0xC1: 'G', 0xC2: 'H', 0xC3: 'I',
            0xC4: 'J', 0xC5: 'K', 0xC6: 'L', 0xC7: 'M', 0xC8: 'N',
            0xC9: 'O', 0xCA: 'P', 0xCB: 'Q', 0xCC: 'R', 0xCD: 'S',
            0xCE: 'T', 0xCF: 'U', 0xD0: 'V', 0xD1: 'W', 0xD2: 'X',
            0xD3: 'Y', 0xD4: 'Z', 0xD5: 'a', 0xD6: 'b', 0xD7: 'c',
            0xD8: 'd', 0xD9: 'e', 0xDA: 'f', 0xDB: 'g', 0xDC: 'h',
            0xDD: 'i', 0xDE: 'j', 0xDF: 'k', 0xE0: 'l', 0xE1: 'm',
            0xE2: 'n', 0xE3: 'o', 0xE4: 'p', 0xE5: 'q', 0xE6: 'r',
            0xE7: 's', 0xE8: 't', 0xE9: 'u', 0xEA: 'v', 0xEB: 'w',
            0xEC: 'x', 0xED: 'y', 0xEE: 'z', 0xEF: '‚ñ∂', 0xF0: ':',
            0xF1: '√Ñ', 0xF2: '√ñ', 0xF3: '√ú', 0xF4: '√§', 0xF5: '√∂', 0xF6: '√º'
        };

        // Vanilla addresses
        var VANILLA_ADDRESSES = {
            gameCode: 0xAC,
            gameName: 0xA0,
            pokemonStats: 0x3203CC,
            pokemonNames: 0x318608,
            moveData: 0x31C898,
            moveNames: 0x31977C,
            itemData: 0x3C5A68,
            typeNames: 0x31AE38,
            abilityNames: 0x31B6DB,
            natureNames: 0x31E818
        };

        // Type names
        var TYPE_NAMES = [
            "Normal", "Fighting", "Flying", "Poison", "Ground", "Rock", "Bug", "Ghost", "Steel",
            "???", "Fire", "Water", "Grass", "Electric", "Psychic", "Ice", "Dragon", "Dark"
        ];

        // Initialize when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing...');
            setupDropZones();
            setupTabs();
            setupSearch();
        });

        function setupDropZones() {
            var vanillaZone = document.getElementById('vanillaDropZone');
            var vanillaInput = document.getElementById('vanillaInput');
            var patchedZone = document.getElementById('patchedDropZone');
            var patchedInput = document.getElementById('patchedInput');
            
            setupDropZone(vanillaZone, vanillaInput, 'vanilla');
            setupDropZone(patchedZone, patchedInput, 'patched');
        }

        function setupDropZone(zone, input, type) {
            zone.addEventListener('dragover', function(e) {
                e.preventDefault();
                zone.classList.add('active');
            });

            zone.addEventListener('dragleave', function() {
                zone.classList.remove('active');
            });

            zone.addEventListener('drop', function(e) {
                e.preventDefault();
                zone.classList.remove('active');
                var file = e.dataTransfer.files[0];
                if (file) loadROM(file, type);
            });

            zone.addEventListener('click', function() {
                input.click();
            });
            
            input.addEventListener('change', function(e) {
                var file = e.target.files[0];
                if (file) loadROM(file, type);
            });
        }

        function setupTabs() {
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) {
                tabs[i].addEventListener('click', function() {
                    var allTabs = document.querySelectorAll('.tab');
                    var allPanels = document.querySelectorAll('.content-panel');
                    
                    for (var j = 0; j < allTabs.length; j++) {
                        allTabs[j].classList.remove('active');
                    }
                    for (var k = 0; k < allPanels.length; k++) {
                        allPanels[k].classList.remove('active');
                    }
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            }
        }

        function setupSearch() {
            var searches = ['pokemonSearch', 'moveSearch', 'itemSearch', 'textSearch'];
            var types = ['Pokemon', 'Moves', 'Items', 'Text'];
            
            for (var i = 0; i < searches.length; i++) {
                var search = document.getElementById(searches[i]);
                if (search) {
                    search.addEventListener('input', createFilterFunction(types[i]));
                }
            }
        }

        function createFilterFunction(type) {
            return function(e) {
                filterData(type, e.target.value);
            };
        }

        function loadROM(file, type) {
            console.log('Loading ROM:', file.name);
            
            if (!file.name.endsWith('.gba')) {
                showError('Please select a .gba ROM file');
                return;
            }

            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var buffer = new Uint8Array(e.target.result);
                    
                    // Verify Pokemon Emerald
                    var gameCode = readString(buffer, VANILLA_ADDRESSES.gameCode, 4);
                    if (gameCode !== 'BPEE') {
                        showError('Not Pokemon Emerald. Game code: ' + gameCode);
                        return;
                    }

                    // Store buffer
                    romData[type].buffer = buffer;
                    romData[type].loaded = true;
                    
                    // Update UI
                    var zone = document.querySelector('#' + type + 'DropZone');
                    zone.classList.add('loaded');
                    zone.querySelector('.loaded-info').classList.remove('hidden');
                    zone.querySelector('.drop-icon').innerHTML = '<div class="spinner"></div>';
                    
                    // Analyze ROM
                    analyzeROM(type).then(function() {
                        if (romData.vanilla.loaded && romData.patched.loaded) {
                            compareROMs();
                            document.getElementById('mainTabs').classList.remove('hidden');
                            var panels = document.querySelectorAll('.content-panel');
                            for (var i = 0; i < panels.length; i++) {
                                panels[i].classList.remove('hidden');
                            }
                        }
                    }).catch(function(error) {
                        showError('Analysis error: ' + error.message);
                    });
                    
                } catch (error) {
                    showError('Load error: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showError('Failed to read ROM file');
            };
            
            reader.readAsArrayBuffer(file);
        }

        function analyzeROM(type) {
            return new Promise(function(resolve, reject) {
                try {
                    var data = romData[type];
                    
                    if (type === 'vanilla') {
                        data.addresses = copyObject(VANILLA_ADDRESSES);
                    } else {
                        findAllRelocatedData(data.buffer).then(function(addresses) {
                            data.addresses = addresses;
                            finishAnalysis(type);
                            resolve();
                        }).catch(reject);
                        return;
                    }
                    
                    finishAnalysis(type);
                    resolve();
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function finishAnalysis(type) {
            loadPokemonData(type);
            loadMoveData(type);
            loadItemData(type);
            
            var zone = document.querySelector('#' + type + 'DropZone');
            zone.querySelector('.drop-icon').innerHTML = '‚úì';
        }

        function findAllRelocatedData(buffer) {
            return new Promise(function(resolve) {
                var addresses = copyObject(VANILLA_ADDRESSES);
                
                // Simple pattern search for Pokemon stats
                var bulbasaurStats = [45, 49, 49, 45, 65, 65];
                var statsOffset = findPattern(buffer, bulbasaurStats);
                if (statsOffset !== -1) {
                    addresses.pokemonStats = statsOffset;
                }
                
                resolve(addresses);
            });
        }

        function findPattern(buffer, pattern) {
            for (var i = 0; i < buffer.length - pattern.length; i++) {
                var found = true;
                for (var j = 0; j < pattern.length; j++) {
                    if (buffer[i + j] !== pattern[j]) {
                        found = false;
                        break;
                    }
                }
                if (found) return i;
            }
            return -1;
        }

        function loadPokemonData(type) {
            var data = romData[type];
            data.pokemon = [];
            
            if (!data.addresses.pokemonStats) return;
            
            for (var i = 0; i < 50; i++) {
                var statsOffset = data.addresses.pokemonStats + (i * 28);
                var nameOffset = data.addresses.pokemonNames ? data.addresses.pokemonNames + (i * 11) : 0;
                
                if (statsOffset >= data.buffer.length) break;
                
                var pokemon = {
                    id: i,
                    name: nameOffset ? decodePokemonString(readBytes(data.buffer, nameOffset, 11)) : 'Pokemon #' + i,
                    stats: {
                        hp: data.buffer[statsOffset],
                        attack: data.buffer[statsOffset + 1],
                        defense: data.buffer[statsOffset + 2],
                        speed: data.buffer[statsOffset + 3],
                        spAttack: data.buffer[statsOffset + 4],
                        spDefense: data.buffer[statsOffset + 5]
                    },
                    types: [data.buffer[statsOffset + 6], data.buffer[statsOffset + 7]],
                    address: statsOffset
                };
                
                pokemon.bst = pokemon.stats.hp + pokemon.stats.attack + pokemon.stats.defense + 
                            pokemon.stats.speed + pokemon.stats.spAttack + pokemon.stats.spDefense;
                data.pokemon.push(pokemon);
            }
        }

        function loadMoveData(type) {
            var data = romData[type];
            data.moves = [];
            
            if (!data.addresses.moveData) return;
            
            for (var i = 0; i < 50; i++) {
                var offset = data.addresses.moveData + (i * 12);
                
                if (offset + 12 > data.buffer.length) break;
                
                var move = {
                    id: i,
                    name: 'Move #' + i,
                    effect: data.buffer[offset],
                    power: data.buffer[offset + 1],
                    type: data.buffer[offset + 2],
                    accuracy: data.buffer[offset + 3],
                    pp: data.buffer[offset + 4],
                    address: offset
                };
                
                data.moves.push(move);
            }
        }

        function loadItemData(type) {
            var data = romData[type];
            data.items = [];
            
            if (!data.addresses.itemData) return;
            
            for (var i = 0; i < 50; i++) {
                var offset = data.addresses.itemData + (i * 44);
                
                if (offset + 44 > data.buffer.length) break;
                
                var item = {
                    id: i,
                    name: decodePokemonString(readBytes(data.buffer, offset, 14)),
                    price: readUInt16(data.buffer, offset + 16),
                    address: offset
                };
                
                data.items.push(item);
            }
        }

        function compareROMs() {
            var statusGrid = document.getElementById('statusGrid');
            var vanilla = romData.vanilla;
            var patched = romData.patched;
            
            var addressComparison = [];
            var keys = Object.keys(vanilla.addresses);
            
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var vanillaAddr = vanilla.addresses[key];
                var patchedAddr = patched.addresses[key];
                var status, statusClass;
                
                if (!patchedAddr) {
                    status = 'Not Found';
                    statusClass = 'not-found';
                } else if (vanillaAddr === patchedAddr) {
                    status = 'Same Location';
                    statusClass = 'found';
                } else {
                    status = 'Moved to 0x' + patchedAddr.toString(16).toUpperCase();
                    statusClass = 'moved';
                }
                
                addressComparison.push({
                    name: key,
                    vanilla: vanillaAddr,
                    patched: patchedAddr,
                    status: status,
                    statusClass: statusClass
                });
            }
            
            // Build HTML
            var html = '';
            for (var j = 0; j < addressComparison.length; j++) {
                var comp = addressComparison[j];
                html += '<div class="status-item">';
                html += '<div class="status-label">' + comp.name + '</div>';
                html += '<div class="status-value ' + comp.statusClass + '">' + comp.status + '</div>';
                html += '</div>';
            }
            statusGrid.innerHTML = html;
            
            document.getElementById('statusPanel').classList.add('active');
            
            displayComparisons();
        }

        function displayComparisons() {
            displayAddressComparison();
            displayPokemonComparison();
            displayMoveComparison();
            displayItemComparison();
        }

        function displayAddressComparison() {
            var vanillaDiv = document.getElementById('vanillaAddresses');
            var patchedDiv = document.getElementById('patchedAddresses');
            
            var vanillaHtml = '';
            var patchedHtml = '';
            var keys = Object.keys(romData.vanilla.addresses);
            
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var vanillaAddr = romData.vanilla.addresses[key];
                var patchedAddr = romData.patched.addresses[key];
                
                vanillaHtml += '<div class="data-item">';
                vanillaHtml += '<div class="data-header"><span class="data-name">' + key + '</span></div>';
                vanillaHtml += '<div class="address-info">0x' + (vanillaAddr + 0x08000000).toString(16).toUpperCase() + '</div>';
                vanillaHtml += '</div>';
                
                var isDifferent = patchedAddr !== vanillaAddr;
                patchedHtml += '<div class="data-item' + (isDifferent ? ' different' : '') + '">';
                patchedHtml += '<div class="data-header"><span class="data-name">' + key + '</span></div>';
                patchedHtml += '<div class="address-info">0x' + (patchedAddr + 0x08000000).toString(16).toUpperCase() + '</div>';
                if (isDifferent) {
                    patchedHtml += '<div style="color: #f39c12; font-size: 0.75rem;">‚Üê Relocated</div>';
                }
                patchedHtml += '</div>';
            }
            
            vanillaDiv.innerHTML = vanillaHtml;
            patchedDiv.innerHTML = patchedHtml;
        }

        function displayPokemonComparison() {
            var vanillaDiv = document.getElementById('vanillaPokemon');
            var patchedDiv = document.getElementById('patchedPokemon');
            
            var vanillaHtml = '';
            var patchedHtml = '';
            
            for (var i = 0; i < romData.vanilla.pokemon.length; i++) {
                vanillaHtml += createPokemonCard(romData.vanilla.pokemon[i]);
            }
            
            for (var j = 0; j < romData.patched.pokemon.length; j++) {
                patchedHtml += createPokemonCard(romData.patched.pokemon[j]);
            }
            
            vanillaDiv.innerHTML = vanillaHtml;
            patchedDiv.innerHTML = patchedHtml;
        }

        function createPokemonCard(pokemon) {
            if (!pokemon || pokemon.bst === 0) return '';
            
            var html = '<div class="data-item" data-id="' + pokemon.id + '">';
            html += '<div class="data-header">';
            html += '<span class="data-name">' + pokemon.name + '</span>';
            html += '<span class="data-id">#' + padLeft(pokemon.id.toString(), 3, '0') + '</span>';
            html += '</div>';
            
            // Type badges
            if (pokemon.types[0] < TYPE_NAMES.length) {
                html += '<span class="type-badge type-' + TYPE_NAMES[pokemon.types[0]].toLowerCase() + '">';
                html += TYPE_NAMES[pokemon.types[0]] + '</span>';
            }
            if (pokemon.types[1] !== pokemon.types[0] && pokemon.types[1] < TYPE_NAMES.length) {
                html += '<span class="type-badge type-' + TYPE_NAMES[pokemon.types[1]].toLowerCase() + '">';
                html += TYPE_NAMES[pokemon.types[1]] + '</span>';
            }
            
            html += '<div style="margin-top: 0.5rem; font-size: 0.875rem;">';
            html += 'BST: ' + pokemon.bst + ' (' + pokemon.stats.hp + '/' + pokemon.stats.attack + '/';
            html += pokemon.stats.defense + '/' + pokemon.stats.spAttack + '/' + pokemon.stats.spDefense + '/';
            html += pokemon.stats.speed + ')';
            html += '</div>';
            html += '<div class="address-info">@ 0x' + (pokemon.address + 0x08000000).toString(16).toUpperCase() + '</div>';
            html += '</div>';
            
            return html;
        }

        function displayMoveComparison() {
            var vanillaDiv = document.getElementById('vanillaMoves');
            var patchedDiv = document.getElementById('patchedMoves');
            
            var vanillaHtml = '';
            var patchedHtml = '';
            
            for (var i = 0; i < romData.vanilla.moves.length; i++) {
                vanillaHtml += createMoveCard(romData.vanilla.moves[i]);
            }
            
            for (var j = 0; j < romData.patched.moves.length; j++) {
                patchedHtml += createMoveCard(romData.patched.moves[j]);
            }
            
            vanillaDiv.innerHTML = vanillaHtml;
            patchedDiv.innerHTML = patchedHtml;
        }

        function createMoveCard(move) {
            if (!move) return '';
            
            var html = '<div class="data-item" data-id="' + move.id + '">';
            html += '<div class="data-header">';
            html += '<span class="data-name">' + move.name + '</span>';
            html += '<span class="data-id">#' + move.id + '</span>';
            html += '</div>';
            
            if (move.type < TYPE_NAMES.length) {
                html += '<span class="type-badge type-' + TYPE_NAMES[move.type].toLowerCase() + '">';
                html += TYPE_NAMES[move.type] + '</span>';
            }
            
            html += '<div style="margin-top: 0.5rem; font-size: 0.875rem;">';
            html += 'Power: ' + (move.power || '-') + ' | Accuracy: ' + (move.accuracy || '-') + ' | PP: ' + move.pp;
            html += '</div>';
            html += '<div class="address-info">@ 0x' + (move.address + 0x08000000).toString(16).toUpperCase() + '</div>';
            html += '</div>';
            
            return html;
        }

        function displayItemComparison() {
            var vanillaDiv = document.getElementById('vanillaItems');
            var patchedDiv = document.getElementById('patchedItems');
            
            var vanillaHtml = '';
            var patchedHtml = '';
            
            for (var i = 0; i < romData.vanilla.items.length; i++) {
                vanillaHtml += createItemCard(romData.vanilla.items[i]);
            }
            
            for (var j = 0; j < romData.patched.items.length; j++) {
                patchedHtml += createItemCard(romData.patched.items[j]);
            }
            
            vanillaDiv.innerHTML = vanillaHtml;
            patchedDiv.innerHTML = patchedHtml;
        }

        function createItemCard(item) {
            if (!item) return '';
            
            var html = '<div class="data-item" data-id="' + item.id + '">';
            html += '<div class="data-header">';
            html += '<span class="data-name">' + item.name + '</span>';
            html += '<span class="data-id">#' + item.id + '</span>';
            html += '</div>';
            html += '<div style="margin-top: 0.5rem; font-size: 0.875rem;">';
            html += 'Price: ¬•' + item.price;
            html += '</div>';
            html += '<div class="address-info">@ 0x' + (item.address + 0x08000000).toString(16).toUpperCase() + '</div>';
            html += '</div>';
            
            return html;
        }

        function runComprehensiveSearch() {
            var results = document.getElementById('patternResults');
            results.innerHTML = '<div class="loading">Running analysis...<div class="spinner"></div></div>';
            
            setTimeout(function() {
                results.innerHTML = '<div class="address-match">Analysis complete - basic implementation</div>';
            }, 2000);
        }

        function filterData(type, search) {
            var cards = document.querySelectorAll('#vanilla' + type + ' .data-item, #patched' + type + ' .data-item');
            
            for (var i = 0; i < cards.length; i++) {
                var card = cards[i];
                var name = card.querySelector('.data-name').textContent.toLowerCase();
                var idElement = card.querySelector('.data-id');
                var id = idElement ? idElement.textContent : '';
                var shouldShow = name.indexOf(search.toLowerCase()) !== -1 || id.indexOf(search) !== -1;
                card.style.display = shouldShow ? '' : 'none';
            }
        }

        function exportCompleteAnalysis(type) {
            var data = romData[type];
            if (!data.loaded) {
                showError('Please load a ROM first');
                return;
            }
            
            var analysis = {
                romType: type,
                gameCode: 'BPEE',
                addresses: data.addresses,
                timestamp: new Date().toISOString()
            };
            
            var json = JSON.stringify(analysis, null, 2);
            downloadFile(type + '_analysis.json', json);
        }

        function exportBizHawkModule() {
            var patched = romData.patched;
            if (!patched.loaded) {
                showError('Please load a patched ROM first');
                return;
            }
            
            var luaModule = '-- Pokemon Emerald ROM Data\n';
            luaModule += 'local ROMData = {}\n\n';
            luaModule += 'ROMData.addresses = {\n';
            
            var keys = Object.keys(patched.addresses);
            for (var i = 0; i < keys.length; i++) {
                var key = keys[i];
                var addr = patched.addresses[key];
                luaModule += '    ' + key + ' = 0x' + (addr + 0x08000000).toString(16).toUpperCase() + ',\n';
            }
            
            luaModule += '}\n\nreturn ROMData';
            
            downloadFile('ROMData_Patched.lua', luaModule);
        }

        function exportComparisonReport() {
            if (!romData.vanilla.loaded || !romData.patched.loaded) {
                showError('Please load both ROMs first');
                return;
            }
            
            var report = 'Pokemon Emerald ROM Comparison Report\n';
            report += 'Generated: ' + new Date().toLocaleString() + '\n\n';
            
            downloadFile('ROM_Comparison_Report.txt', report);
        }

        // Utility functions
        function readString(buffer, offset, length) {
            var str = '';
            for (var i = 0; i < length; i++) {
                var char = buffer[offset + i];
                if (char === 0) break;
                str += String.fromCharCode(char);
            }
            return str;
        }

        function readBytes(buffer, offset, length) {
            var bytes = [];
            for (var i = 0; i < length; i++) {
                if (offset + i < buffer.length) {
                    bytes.push(buffer[offset + i]);
                }
            }
            return bytes;
        }

        function readUInt16(buffer, offset) {
            if (offset + 1 >= buffer.length) return 0;
            return buffer[offset] | (buffer[offset + 1] << 8);
        }

        function decodePokemonString(bytes) {
            var str = '';
            for (var i = 0; i < bytes.length; i++) {
                var byte = bytes[i];
                if (byte === 0xFF) break;
                str += POKEMON_ENCODING[byte] || '';
            }
            return str.trim();
        }

        function showError(message) {
            var errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'Error: ' + message;
            
            var container = document.querySelector('.container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(function() {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function downloadFile(filename, content) {
            var blob = new Blob([content], { type: 'text/plain' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyObject(obj) {
            var copy = {};
            var keys = Object.keys(obj);
            for (var i = 0; i < keys.length; i++) {
                copy[keys[i]] = obj[keys[i]];
            }
            return copy;
        }

        function padLeft(str, len, pad) {
            while (str.length < len) {
                str = pad + str;
            }
            return str;
        }
    </script>
</body>
</html>